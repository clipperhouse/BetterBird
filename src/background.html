<html>
<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script>

var findTab = function(callback) {
    chrome.tabs.query({ url : "*://twitter.com/*" }, callback);  
};

var firstRun = function() {
    findTab(function(tabs) {
        if (tabs.length) {
            chrome.tabs.update(tabs[0].id, { url: "http://twitter.com", active: true });
        } else {
            chrome.tabs.create({ url: "http://twitter.com" });
        }
    });  
};

firstRun();
chrome.browserAction.onClicked.addListener(function() {
    findTab(function(tabs) {
        if (tabs.length) {
            chrome.tabs.update(tabs[0].id, { active: true });
        } else {
            chrome.tabs.create({ url: "http://twitter.com" });
        }
    });  
});

var currentversion = "0.3";
var optionskey = "options";
var defaultoptions = {
    version: currentversion,
    styles: {
        columnswitch: true,
        columnwide: true,
        font: false,
        hidewho: false,
        hidetrends: false
    },
    expandurls: true,
    directtoprofile: true,
    savedsearches: true
};

var loadOptions = function () {
    var options = {};
    var optionsjson = localStorage[optionskey];
    if (optionsjson) {
        options = JSON.parse(optionsjson);
    }

    if (options.version != defaultoptions.version) {
        return $.extend(true, options, defaultoptions);      // deal with version changes over time
    }

    return options;
};

var saveOptions = function (options) {
    localStorage[optionskey] = JSON.stringify(options);
    return true;
};

chrome.extension.onRequest.addListener(function(request, sender, callback) {
    switch(request.type) {
        case "load-options":
            callback(loadOptions());
            break;
        case "save-options":
            callback({ success: saveOptions(request.options) });
            break;
        default:
    }
});
</script>
</html>