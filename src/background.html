<html>
<script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
<script>

var findTab = function(callback) {
    chrome.tabs.query({ url : "*://twitter.com/*" }, callback);  
};

function onInstall() {
    findTab(function(tabs) {
        if (tabs.length) {
            chrome.tabs.update(tabs[0].id, { url: "http://twitter.com", active: true });
        } else {
            chrome.tabs.create({ url: "http://twitter.com" });
        }
    });  
}

function onUpdate() {
    onInstall();
}

function getVersion() {
    var details = chrome.app.getDetails();
    return details.version;
}

// Check if the version has changed.
var currVersion = getVersion();
var prevVersion = localStorage['version']
if (currVersion != prevVersion) {
    if (typeof prevVersion == 'undefined') {
      onInstall();
    } else {
      onUpdate();
    }
    localStorage['version'] = currVersion;
}

chrome.browserAction.onClicked.addListener(function() {
    findTab(function(tabs) {
        if (tabs.length) {
            chrome.tabs.update(tabs[0].id, { active: true });
            chrome.tabs.sendRequest(tabs[0].id, { "type": "go-home" });
        } else {
            chrome.tabs.create({ url: "http://twitter.com" });
        }
    });
});

var currentversion = getVersion();
var optionskey = "options";
var defaultoptions = {
    version: currentversion,
    styles: {
        columnswitch: true,
        columnwide: true,
        font: false,
        hidewho: false,
        hidetrends: false
    },
    collapse: {
        options: false,
        savedsearch: true,
        mentions: true
    },
    expandurls: true,
    directtoprofile: true,
    savedsearches: true,
    mentions: true
};

var loadOptions = function () {
    var options = {};
    var optionsjson = localStorage[optionskey];
    if (optionsjson) {
        options = JSON.parse(optionsjson);
    }

    if (options.version != defaultoptions.version) {
        return $.extend(true, defaultoptions, options);      // deal with version changes over time
    }

    return options;
};

var saveOptions = function (options) {
    localStorage[optionskey] = JSON.stringify(options);
    return true;
};

var doSearch = function(q, callback){
    var storagekey = "refreshurl." + q;
    var qs = localStorage[storagekey] || "?q=" + encodeURIComponent(q) + "&rpp=100";
    var url = "http://search.twitter.com/search.json" + qs;
    $.getJSON(url, function (response) {
        localStorage[storagekey] = response.refresh_url;
        callback(response);
    });
};

var setNotifyIcon = function(notify) {
    chrome.browserAction.setIcon({ path: notify ? "img/twitter_32_notify.png" : "img/twitter_32.png" });
};

chrome.extension.onRequest.addListener(function(request, sender, callback) {
    switch(request.type) {
        case "load-options":
            callback(loadOptions());
            break;
        case "save-options":
            callback({ success: saveOptions(request.options) });
            break;
        case "do-search":
            doSearch(request.q, callback);
            break;
        case "set-icon":
            setNotifyIcon(request.notify);
            break;
        default:
    }
});
</script>
</html>